# ç¬¬ä¹ç« ï¼šæ³›å‹ Generics

## 9.3 ä½¿ç”¨æ³›å‹è¿›è¡Œä»£ç è®¾è®¡ Designing with Generics
æœ¬å°èŠ‚å°±æ¯”è¾ƒ```å®ç”¨```äº†ï¼Œå¯¹```ç½‘ç»œè¯·æ±‚ä»¥åŠæ•°æ®è½¬æ¨¡å‹```çš„å®é™…åœºæ™¯ä½¿ç”¨äº†```æ³›å‹çš„äºŒæ¬¡å°è£…```ã€‚
è¿™æ ·çš„ç¼–ç¨‹æ€æƒ³è¿˜æ˜¯å¾ˆé…·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­æ¨å¹¿ä¸€ä¸‹

##### æ™®é€šæ—¶å€™æˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚å·²ç»æ•°æ®è½¬æ¨¡å‹çš„ä»£ç 

        func loadUsers(callback: ([User]?) -> ()) {
            ///è·å–æ•°æ®
            let usersURL = webserviceURL.appendingPathComponent("/users") let data = try? Data(contentsOf: usersURL)
            ///æ•°æ®è½¬æ¨¡å‹
            let json = data.flatMap {
            try? JSONSerialization.jsonObject(with: $0, options: []) }
            let users = (json as? [Any]).flatMap { jsonObject in jsonObject.flatMap(User.init)
            }
            ///å›è°ƒ
            callback(users) 
        }

éœ€è¦æ³¨æ„çš„æ˜¯

1ï¸âƒ£ç½‘ç»œè¯·æ±‚å¯èƒ½å¤±è´¥ 

2ï¸âƒ£JSONè§£æå¯èƒ½å¤±è´¥ 

3ï¸âƒ£æ•°æ®è½¬æ¨¡å‹å¯èƒ½å¤±è´¥ 
æˆ‘ä»¬éƒ½éœ€è¦è¿”å›nilï¼Œ å¯¹å›è°ƒä½¿ç”¨flapMapæ¥æ’é™¤nilçš„æƒ…å†µ

### æå–å…±é€šåŠŸèƒ½
ä¸Šé¢çš„Demoæ˜¯å¯¹[User]æ¨¡å‹çš„ç½‘ç»œè¯·æ±‚ï¼Œ å¦‚æœæˆ‘ä»¬éœ€è¦è¯·æ±‚è®¢å•é‡[Bill]çš„ç½‘ç»œè¯·æ±‚ï¼Œåˆéœ€è¦å†™ä¸€ä¸ªæ–°çš„æ–¹æ³•é‡å¤å†™å¾ˆå¤šä»£ç ã€‚
```è¿™æ ·ä¸å¯å–```
æˆ‘ä»¬å¯ä»¥æŠŠå‡½æ•°ä¸­çš„Useræå–å‡ºæ¥ï¼Œ URLStringä½œä¸ºå‚æ•°ä¼ å…¥æ¥å°è£…ä¸€ä¸ªæ³›å‹æ–¹æ³• loadResourceï¼Œ å£°æ˜ä¸º``` A ```çš„æ³›å‹ 

        func loadResource<A>(at path: String, parse: (Any) -> A?, callback: (A?) -> ())
        {
            let resourceURL = webserviceURL.appendingPathComponent(path) let data = try? Data(contentsOf: resourceURL)
            let json = data.flatMap {
            try? JSONSerialization.jsonObject(with: $0, options: []) }
            callback(json.flatMap(parse)) 
        }
        

å°è£…å®Œæ¯•ä¹‹åæˆ‘ä»¬å¯¹è¯·æ±‚[User]çš„ç½‘ç»œè¯·æ±‚å°±å¯ä»¥è¿™æ ·å†™äº†

        func loadUsers(callback: ([User]?) -> ()) {
            loadResource(at: "/users", parse: jsonArray(User.init), callback: callback)
        }

ä¸Šé¢ç”¨äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œ```jsonArray``` ä¸»è¦ä½œç”¨æ˜¯ï¼š å®ƒé¦–å…ˆå°è¯•å°†ä¸€ä¸ª Any è½¬æ¢ä¸ºä¸€ä¸ª Any çš„æ•°ç»„ï¼Œæ¥ç€ å¯¹æ¯ä¸ªå…ƒç´ ç”¨æä¾›çš„è§£æå‡½æ•°è¿›è¡Œè§£æï¼Œå¦‚æœæœŸé—´ä»»ä½•ä¸€æ­¥å‘ç”Ÿäº†é”™è¯¯ï¼Œåˆ™è¿”å› nil:
        
        func jsonArray<A>(_ transform: @escaping (Any) -> A?) -> (Any) -> [A]?  
        {
             return { array in
                guard let array = array as? [Any] else { return nil
            }
            return array.flatMap(transform) }
        }

### äºŒæ¬¡ä¼˜åŒ–--åˆ›å»ºæ³›å‹æ•°æ®ç±»å‹

ä¸Šé¢çš„loadResourceå‡½æ•°ä¸­  path å’Œ parse ```è€¦åˆéå¸¸ç´§``` ï¼Œ ä¸€æ—¦pathæ”¹å˜äº† parseä¹Ÿä¼šä¸€èµ·æ”¹å˜ã€‚
æˆ‘ä»¬å¯ä»¥å°è£…æˆä¸€ä¸ª```ç»“æ„ä½“```ï¼Œæ¥```æè¿°è¦åŠ è½½çš„èµ„æº```
    
    struct Resource<A> { 
        let path: String
        let parse: (Any) -> A?
    }

æ¥ä¸‹æ¥ æˆ‘ä»¬å¯ä»¥ç»™ æˆ‘ä»¬å·²ç»å°è£…å¥½çš„ç»“æ„ä½“ Resource ç»“æ„ä½“æ¥å®šä¹‰ä¸€ä¸ª```extension``` è®©Resource ç›´æ¥è°ƒç”¨ç½‘ç»œè¯·æ±‚æ•°æ®è½¬æ¨¡å‹çš„æ–¹æ³•

    extension Resource {
        func loadSynchronously(callback: (A?) -> ()) {
            let resourceURL = webserviceURL.appendingPathComponent(path) let data = try? Data(contentsOf: resourceURL)
            let json = data.flatMap {
            try? JSONSerialization.jsonObject(with: $0, options: []) }
            callback(json.flatMap(parse)) }
    }


####  æœ€ç»ˆæˆ‘ä»¬å°è£…å¥½çš„æˆ˜æœğŸ˜~
    ///ç½‘ç»œè¯·æ±‚ä¸€ä¸ªç”¨æˆ·æ¨¡å‹æ•°ç»„å°±å˜çš„å¦‚æ­¤æ–¹ä¾¿ã€‚
    let usersResource: Resource<[User]> = Resource(path: "/users", parse:jsonArray(User.init))
    userResourse.loadSynchronously = { userModels in  
        ///æˆ‘å–åˆ°äº†æˆ‘æƒ³è¦çš„ userModels æ¨¡å‹æ•°ç»„å•¦~~
    }


##### æ„Ÿæ‚Ÿ  
è¿™ä¸€å°èŠ‚æ˜¯çœŸçš„æœ‰ç”¨ï¼Œå¯¹äºæˆ‘ä»¬å®é™…å¼€å‘åŠä»£ç é£æ ¼æœ‰å¾ˆå¤§çš„å¯å‘ã€‚ ä¸‹æ¬¡ä»£ç ä¼˜åŒ–çš„æ—¶å€™æˆ–è®¸å¯ä»¥è¯•è¯•è¿™æ ·çš„å°è£…æ€æƒ³ã€‚

